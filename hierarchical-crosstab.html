<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hierarchical Drill-Down Crosstab</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --hover-bg: #e9ecef;
            --expanded-bg: #f1f3f5;
            --accent-color: #0066cc;
            --indent-size: 24px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 13px;
            color: var(--text-primary);
            background: var(--primary-bg);
            line-height: 1.5;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100vh;
            overflow: auto;
        }

        #loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 14px;
            color: var(--text-secondary);
        }

        #error {
            display: none;
            padding: 24px;
            color: #dc3545;
            background: #fff5f5;
            border: 1px solid #fcc;
            border-radius: 4px;
            margin: 16px;
        }

        .crosstab {
            width: 100%;
            border-collapse: collapse;
            background: var(--primary-bg);
        }

        .crosstab thead th {
            position: sticky;
            top: 0;
            background: var(--secondary-bg);
            font-weight: 600;
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid var(--border-color);
            z-index: 10;
            white-space: nowrap;
        }

        .crosstab thead th.measure-header {
            text-align: right;
        }

        .crosstab tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.15s ease;
        }

        .crosstab tbody tr:hover {
            background: var(--hover-bg);
        }

        .crosstab tbody td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .crosstab tbody td.row-header {
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        .crosstab tbody td.row-header:hover {
            color: var(--accent-color);
        }

        .crosstab tbody td.measure-cell {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .row-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expand-icon {
            display: inline-flex;
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
            opacity: 0.6;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .expand-icon.hidden {
            opacity: 0;
        }

        .crosstab tbody tr[data-level="0"] td.row-header {
            font-weight: 600;
            background: var(--secondary-bg);
        }

        .spinner {
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <span style="margin-left: 12px;">Loading extension...</span>
    </div>
    <div id="error"></div>
    <div id="container" style="display: none;">
        <table class="crosstab" id="crosstab"></table>
    </div>

    <!-- Load Tableau Extensions API -->
    <script src="../../Extensions/tableau.extensions.1.latest.js"></script>
    
    <!-- Extension Logic -->
    <script>
    (function() {
        'use strict';

        let worksheet = null;
        let hierarchyFields = [];
        let measureFields = [];
        let fullDataTree = null;
        let expandedNodes = new Set();

        // Wait for Tableau API to be available
        function init() {
            if (typeof tableau === 'undefined' || !tableau.extensions) {
                setTimeout(init, 100);
                return;
            }

            tableau.extensions.initializeAsync().then(() => {
                console.log('✅ Extension initialized');
                loadData();
            }).catch(err => {
                showError('Failed to initialize: ' + err.message);
            });
        }

        init();

        async function loadData() {
            try {
                worksheet = tableau.extensions.worksheetContent.worksheet;
                const dataTable = await worksheet.getSummaryDataReaderAsync();
                const columns = dataTable.columns;

                identifyFieldTypes(columns);

                if (hierarchyFields.length === 0) {
                    showError('No dimensions found in Rows');
                    await dataTable.releaseAsync();
                    return;
                }

                if (measureFields.length === 0) {
                    showError('No measures found');
                    await dataTable.releaseAsync();
                    return;
                }

                let allData = [];
                for (let page of dataTable.pages) {
                    allData = allData.concat(page.data);
                }
                await dataTable.releaseAsync();

                fullDataTree = buildHierarchicalTree(allData);
                renderTable();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('container').style.display = 'block';

            } catch (err) {
                showError('Error loading data: ' + err.message);
            }
        }

        function identifyFieldTypes(columns) {
            hierarchyFields = [];
            measureFields = [];

            columns.forEach(col => {
                if (col.dataType === 'string' || col.dataType === 'date-time' || col.dataType === 'date') {
                    hierarchyFields.push({ index: col.index, fieldName: col.fieldName });
                } else if (col.dataType === 'float' || col.dataType === 'int') {
                    measureFields.push({ index: col.index, fieldName: col.fieldName });
                }
            });
        }

        function buildHierarchicalTree(data) {
            const tree = {};
            data.forEach(row => {
                let currentLevel = tree;
                hierarchyFields.forEach((field, levelIndex) => {
                    const value = row[field.index].value;
                    if (value === null || value === undefined || value === '%null%') return;

                    if (!currentLevel[value]) {
                        currentLevel[value] = {
                            name: value,
                            level: levelIndex,
                            measures: {},
                            children: {},
                            hasChildren: levelIndex < hierarchyFields.length - 1
                        };
                    }

                    measureFields.forEach(measure => {
                        const measureValue = row[measure.index].value;
                        if (measureValue !== null && measureValue !== undefined) {
                            currentLevel[value].measures[measure.fieldName] = measureValue;
                        }
                    });

                    currentLevel = currentLevel[value].children;
                });
            });
            return tree;
        }

        function renderTable() {
            const table = document.getElementById('crosstab');
            table.innerHTML = '';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            const hierarchyHeader = document.createElement('th');
            hierarchyHeader.textContent = hierarchyFields[0].fieldName;
            headerRow.appendChild(hierarchyHeader);

            measureFields.forEach(measure => {
                const th = document.createElement('th');
                th.className = 'measure-header';
                th.textContent = measure.fieldName;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            renderTreeLevel(fullDataTree, tbody, 0, []);
            table.appendChild(tbody);
        }

        function renderTreeLevel(treeLevel, tbody, level, path) {
            const sortedKeys = Object.keys(treeLevel).sort();

            sortedKeys.forEach(key => {
                const node = treeLevel[key];
                const currentPath = [...path, key];
                const pathKey = currentPath.join('|');

                const row = document.createElement('tr');
                row.setAttribute('data-level', level);
                
                const isExpanded = expandedNodes.has(pathKey);

                const rowHeader = document.createElement('td');
                rowHeader.className = 'row-header';
                
                const rowContent = document.createElement('div');
                rowContent.className = 'row-content';

                const indent = document.createElement('span');
                indent.style.width = (level * 24) + 'px';
                indent.style.display = 'inline-block';
                rowContent.appendChild(indent);

                if (node.hasChildren && Object.keys(node.children).length > 0) {
                    const icon = document.createElement('span');
                    icon.className = 'expand-icon' + (isExpanded ? ' expanded' : '');
                    icon.innerHTML = '▸';
                    rowContent.appendChild(icon);

                    rowHeader.addEventListener('click', () => toggleNode(currentPath));
                } else {
                    const spacer = document.createElement('span');
                    spacer.className = 'expand-icon hidden';
                    spacer.innerHTML = '&nbsp;';
                    rowContent.appendChild(spacer);
                }

                const nameSpan = document.createElement('span');
                nameSpan.textContent = node.name;
                rowContent.appendChild(nameSpan);

                rowHeader.appendChild(rowContent);
                row.appendChild(rowHeader);

                measureFields.forEach(measure => {
                    const cell = document.createElement('td');
                    cell.className = 'measure-cell';
                    const value = node.measures[measure.fieldName];
                    if (value !== undefined && value !== null) {
                        cell.textContent = formatNumber(value);
                    }
                    row.appendChild(cell);
                });

                tbody.appendChild(row);

                if (isExpanded && node.hasChildren && Object.keys(node.children).length > 0) {
                    renderTreeLevel(node.children, tbody, level + 1, currentPath);
                }
            });
        }

        function toggleNode(path) {
            const pathKey = path.join('|');
            
            if (expandedNodes.has(pathKey)) {
                const pathsToRemove = Array.from(expandedNodes).filter(p => 
                    p === pathKey || p.startsWith(pathKey + '|')
                );
                pathsToRemove.forEach(p => expandedNodes.delete(p));
            } else {
                expandedNodes.add(pathKey);
            }

            renderTable();
        }

        function formatNumber(value) {
            if (typeof value === 'number') {
                if (Math.abs(value) >= 100) {
                    return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                }
                return value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            }
            return value;
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            console.error(message);
        }
    })();
    </script>
</body>
</html>
