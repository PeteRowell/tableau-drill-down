<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hierarchical Drill-Down Crosstab - Debug</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .status-box {
            background: white;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        h2 {
            color: #0066cc;
            margin-bottom: 15px;
        }

        .error {
            background: #ffebee;
            border-color: #f44336;
            padding: 15px;
            border-radius: 4px;
            color: #c62828;
            margin: 10px 0;
        }

        .success {
            background: #e8f5e9;
            border-color: #4caf50;
            padding: 15px;
            border-radius: 4px;
            color: #2e7d32;
            margin: 10px 0;
        }

        .info {
            background: #e3f2fd;
            border-color: #2196f3;
            padding: 15px;
            border-radius: 4px;
            color: #1565c0;
            margin: 10px 0;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        button:hover {
            background: #0052a3;
        }

        #logs {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 4px;
            margin: 2px 0;
            border-left: 3px solid #ccc;
            padding-left: 8px;
        }

        .log-info { border-left-color: #2196f3; }
        .log-success { border-left-color: #4caf50; }
        .log-error { border-left-color: #f44336; background: #ffebee; }
        .log-warning { border-left-color: #ff9800; }
    </style>
</head>
<body>
    <div class="status-box">
        <h2>üîç Tableau Extension Debugger</h2>
        <div id="status"></div>
        
        <h3 style="margin-top: 20px;">Manual Tests:</h3>
        <button onclick="testTableauObject()">Test: tableau object exists</button>
        <button onclick="testExtensionsAPI()">Test: Extensions API available</button>
        <button onclick="testInitialize()">Test: Initialize extension</button>
        <button onclick="clearLogs()">Clear Logs</button>
        
        <h3 style="margin-top: 20px;">Diagnostic Logs:</h3>
        <div id="logs"></div>
    </div>

    <script>
        const logsDiv = document.getElementById('logs');
        const statusDiv = document.getElementById('status');

        function log(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function setStatus(message, className) {
            statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
        }

        // Auto-run on load
        window.addEventListener('load', function() {
            log('‚úÖ Page loaded successfully', 'success');
            log('Current URL: ' + window.location.href, 'info');
            log('User Agent: ' + navigator.userAgent, 'info');
            
            // Wait a moment for any scripts to load
            setTimeout(runDiagnostics, 1000);
        });

        function runDiagnostics() {
            log('üîç Starting automatic diagnostics...', 'info');
            testTableauObject();
            
            setTimeout(() => {
                if (typeof tableau !== 'undefined' && tableau.extensions) {
                    testInitialize();
                }
            }, 500);
        }

        function testTableauObject() {
            log('--- Testing tableau object ---', 'info');
            
            if (typeof tableau === 'undefined') {
                log('‚ùå FAIL: tableau object is undefined', 'error');
                log('This means the Tableau Extensions API script did not load', 'error');
                setStatus('‚ùå Tableau API Not Loaded<br><br>Possible causes:<br>1. Extension not running in Tableau Desktop/Cloud<br>2. API script path is incorrect<br>3. Network/CORS issue preventing script load', 'error');
                
                // Check for script tags
                const scripts = document.getElementsByTagName('script');
                log(`Found ${scripts.length} script tags:`, 'info');
                for (let script of scripts) {
                    log(`  - ${script.src || 'inline script'}`, 'info');
                }
                
                return false;
            } else {
                log('‚úÖ SUCCESS: tableau object exists', 'success');
                log('tableau object type: ' + typeof tableau, 'info');
                log('tableau object keys: ' + Object.keys(tableau).join(', '), 'info');
                return true;
            }
        }

        function testExtensionsAPI() {
            log('--- Testing Extensions API ---', 'info');
            
            if (typeof tableau === 'undefined') {
                log('‚ùå Skipping: tableau object not available', 'warning');
                return false;
            }
            
            if (!tableau.extensions) {
                log('‚ùå FAIL: tableau.extensions is undefined', 'error');
                setStatus('‚ùå Extensions API Not Available', 'error');
                return false;
            }
            
            log('‚úÖ SUCCESS: tableau.extensions exists', 'success');
            log('Extensions API keys: ' + Object.keys(tableau.extensions).join(', '), 'info');
            
            if (tableau.extensions.initializeAsync) {
                log('‚úÖ initializeAsync method found', 'success');
            } else {
                log('‚ùå initializeAsync method NOT found', 'error');
            }
            
            return true;
        }

        function testInitialize() {
            log('--- Testing Extension Initialization ---', 'info');
            
            if (typeof tableau === 'undefined' || !tableau.extensions) {
                log('‚ùå Cannot initialize: API not available', 'error');
                return;
            }
            
            log('üîÑ Calling tableau.extensions.initializeAsync()...', 'info');
            setStatus('üîÑ Initializing...', 'info');
            
            tableau.extensions.initializeAsync()
                .then(() => {
                    log('‚úÖ SUCCESS: Extension initialized!', 'success');
                    setStatus('‚úÖ Extension Initialized Successfully!', 'success');
                    
                    // Get environment info
                    try {
                        const env = tableau.extensions.environment;
                        log('Tableau Version: ' + env.tableauVersion, 'info');
                        log('API Version: ' + env.apiVersion, 'info');
                        log('Mode: ' + env.mode, 'info');
                        
                        // Get worksheet
                        if (tableau.extensions.worksheetContent) {
                            const worksheet = tableau.extensions.worksheetContent.worksheet;
                            log('Worksheet Name: ' + worksheet.name, 'success');
                            
                            setStatus('‚úÖ Ready! Worksheet: ' + worksheet.name, 'success');
                        }
                    } catch (e) {
                        log('‚ö†Ô∏è Error getting environment info: ' + e.message, 'warning');
                    }
                })
                .catch(err => {
                    log('‚ùå INITIALIZATION FAILED', 'error');
                    log('Error: ' + err.message, 'error');
                    log('Error type: ' + err.name, 'error');
                    if (err.stack) {
                        log('Stack trace:', 'error');
                        log(err.stack, 'error');
                    }
                    setStatus('‚ùå Initialization Failed: ' + err.message, 'error');
                });
        }

        // Check if we're in Tableau
        log('Checking environment...', 'info');
        if (window.location.protocol === 'file:') {
            log('‚ö†Ô∏è Running from file:// protocol', 'warning');
        } else if (window.location.protocol === 'https:') {
            log('‚úÖ Running on HTTPS', 'success');
        } else {
            log('‚ö†Ô∏è Running on ' + window.location.protocol, 'warning');
        }
    </script>
</body>
</html>
